function getCookie(e){var t=" "+document.cookie,s=" "+e+"=",o=null,r=0,i=0;return t.length>0&&(r=t.indexOf(s),-1!=r&&(r+=s.length,i=t.indexOf(";",r),-1==i&&(i=t.length),o=unescape(t.substring(r,i)))),o}function comet_server_signal(){return void 0===this.init&&(this.init=!1),comet_server_signal}function CometServer(){return __CometServer||(__CometServer=new cometApi),__CometServer}comet_server_signal.slotArray=new Array,comet_server_signal.debug=!1,comet_server_signal.sigId=0,comet_server_signal.connect=function(e,t,s){return void 0===s&&(s=t,t=e,e="sig"+comet_server_signal.sigId++),void 0===comet_server_signal.slotArray[t]&&(comet_server_signal.slotArray[t]={}),comet_server_signal.slotArray[t][e]=s,comet_server_signal.debug&&console.log("На прослушивание сигнала "+t+" добавлен слот "+e,comet_server_signal.slotArray),e},comet_server_signal.disconnect=function(e,t){return void 0!==comet_server_signal.slotArray[t]&&void 0!==comet_server_signal.slotArray[t][e]?(comet_server_signal.slotArray[t][e]=void 0,!0):!1},comet_server_signal.emit=function(e,t,s){if(void 0===comet_server_signal.slotArray[e])comet_server_signal.debug&&console.log("На сигнал "+e+" нет подписчиков");else{comet_server_signal.debug&&console.log("Сигнал "+e+" подписаны слоты");for(var o in comet_server_signal.slotArray[e])void 0!==comet_server_signal.slotArray[e][o]&&comet_server_signal.slotArray[e][o](t,e,s===!0)}},comet_server_signal.emitAll=function(e,t){if(comet_server_signal.emit(e,t),void 0!==window.localStorage){var s=Math.random()+"_"+Math.random()+"_"+Math.random()+"_"+Math.random()+"_"+Math.random();window.localStorage.comet_server_signal_storage_emit=JSON.stringify({name:e,custom_id:s,param:t})}},tabSignal=comet_server_signal,comet_server_signal.send_emit=comet_server_signal.emitAll,comet_server_signal.prototype.init||(comet_server_signal.prototype.init=!0,window.addEventListener?window.addEventListener("storage",function(e){if(e.key&&"comet_server_signal_storage_emit"==e.key)try{var t=JSON.parse(e.newValue);void 0!==t&&void 0!==t.name&&(comet_server_signal.debug>1&&console.log(t),comet_server_signal().emit(t.name,t.param,!0))}catch(s){}},!1):document.attachEvent("onstorage",function(e){if(e.key&&"comet_server_signal_storage_emit"==e.key)try{var t=JSON.parse(e.newValue);void 0!==t&&void 0!==t.name&&(comet_server_signal.debug>1&&console.log(t),comet_server_signal().emit(t.name,t.param,!0))}catch(s){}})),cometApi=function(e){this.version="2.32",this.nodeName="app.comet-server.ru",this.options=e,this.arg="",this.is_master=void 0,this.in_conect_to_server=!1,this.in_try_conect=!1,this.subscription_array=new Array,this.custom_id=10*Math.random()+""+Math.random(),this.custom_id=this.custom_id.replace(/[^0-9A-z]/,"").replace(/^(.{10}).*$/,"$1"),this.time_to_reconect_on_error=100,this.in_abort=!1,this.restart_time_id=!1,this.start_timer=1200,this.reg_exp=new RegExp(/^([^.]+)\.([^.]+)$/),this.protocol="s",this.web_socket_error=0,this.web_socket_success=!1,this.web_socket_error_timeOut=3e4,this.xhr_error=0,this.xhr_error_timeOut_id=3e4,this.authorized_status,this.socket,this.use_WebSocket,this.request,this.status,this.send_msg_queue=[],this.send_msg_subscription=!1,this.LogLevel=0,window.localStorage.comet_LogLevel&&(this.LogLevel=window.localStorage.comet_LogLevel),this.getLogLevel=function(){return this.LogLevel},this.setLogLevel=function(e){this.LogLevel=e,window.localStorage.comet_LogLevel=e},this.getCustomString=function(){var e=10*Math.random()+""+Math.random();return e.replace(/[^0-9A-z]/,"").replace(/^(.{10}).*$/,"$1")},this.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,s,o,r,i,n,_,c="",a=0;e=e.replace(/\r\n/g,"\n");for(var m="",l=0;l<e.length;l++){var g=e.charCodeAt(l);128>g?m+=String.fromCharCode(g):g>127&&2048>g?(m+=String.fromCharCode(g>>6|192),m+=String.fromCharCode(63&g|128)):(m+=String.fromCharCode(g>>12|224),m+=String.fromCharCode(g>>6&63|128),m+=String.fromCharCode(63&g|128))}for(;a<m.length;)t=m.charCodeAt(a++),s=m.charCodeAt(a++),o=m.charCodeAt(a++),r=t>>2,i=(3&t)<<4|s>>4,n=(15&s)<<2|o>>6,_=63&o,isNaN(s)?n=_=64:isNaN(o)&&(_=64),c=c+this._keyStr.charAt(r)+this._keyStr.charAt(i)+this._keyStr.charAt(n)+this._keyStr.charAt(_);return c},decode:function(e){var t,s,o,r,i,n,_,c="",a=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");a<e.length;)r=this._keyStr.indexOf(e.charAt(a++)),i=this._keyStr.indexOf(e.charAt(a++)),n=this._keyStr.indexOf(e.charAt(a++)),_=this._keyStr.indexOf(e.charAt(a++)),t=r<<2|i>>4,s=(15&i)<<4|n>>2,o=(3&n)<<6|_,c+=String.fromCharCode(t),64!=n&&(c+=String.fromCharCode(s)),64!=_&&(c+=String.fromCharCode(o));for(var m="",a=0,l=c1=c2=0;a<c.length;)l=c.charCodeAt(a),128>l?(m+=String.fromCharCode(l),a++):l>191&&224>l?(c2=c.charCodeAt(a+1),m+=String.fromCharCode((31&l)<<6|63&c2),a+=2):(c2=c.charCodeAt(a+1),c3=c.charCodeAt(a+2),m+=String.fromCharCode((15&l)<<12|(63&c2)<<6|63&c3),a+=3);return m}},this.stripslashes=function(e){return(e+"").replace(/\\(.?)/g,function(e,t){switch(t){case"\\":return"\\";case"0":return"\x00";case"":return"";default:return t}})},this.subscription_callBack=function(e,t,s){var o=this,r=e+"&&";return r+=void 0===s?comet_server_signal().connect(e,function(e){return e.server_info.marker!==o.custom_id&&void 0!==e.server_info.marker?0:void t(e)}):comet_server_signal().connect(s,e,function(o){return o.server_info.marker!==s?0:(comet_server_signal().disconnect(s,e),void t(o))})},this.unsubscription=function(e){var t=e.replace(/^(.*)&&.*$/,"$1"),s=e.replace(/^.*&&(.*)$/,"$1");return comet_server_signal().disconnect(s,t)},this.subscription=function(e,t){if(void 0===e)return!1;var s=this,o=e.split("\n");if(!(o.length>1)){if(void 0===t&&(t=function(){}),"function"==typeof e)return"comet_server_msg&&"+comet_server_signal().connect("comet_server_msg",e);if("msg"===e||/^msg\./.test(e))return s.subscription_callBack(e,t);if(/^answer_to_web_/.test(e))return s.subscription_callBack(e,t);if(/^#/.test(e))return e=e.replace("#","_answer_to_"),s.subscription_callBack(e,t);if(""===e&&(e="comet_server_msg"),e.length<2)return!1;var r=s.subscription_callBack(e,t);if("comet_server_msg"===e)return r;if(this.reg_exp.test(e)){var i=this.reg_exp.exec(e);e=i[1]}for(var n in this.subscription_array)if(this.subscription_array[n]===e)return r;return this.subscription_array[this.subscription_array.length]=e,void 0===this.is_master?this.add_msg_to_queue("subscription\n"+this.subscription_array.join("\n")):this.is_master?(this.LogLevel&&console.log("add subscription:"+e),this.UseWebSocket()?this.send_msg("subscription\n"+this.subscription_array.join("\n")):this.restart()):comet_server_signal().send_emit("comet_msg_slave_add_subscription_and_restart",this.subscription_array.join("\n")),r}for(var n in o)this.subscription(o[n],t)},this.isMaster=function(){return this.is_master},this.send_curent_subscription=function(){this.send_msg("subscription\n"+this.subscription_array.join("\n"))},this.getUrl=function(e){return this.UseWebSocket()===!0?"ws"+this.protocol+"://"+this.nodeName+"/ws/sesion="+this.options.user_key+"&myid="+this.options.user_id+"&devid="+this.options.dev_id+"&v="+this.version+"&api=js":"http"+this.protocol+"://"+this.nodeName+"/sesion="+this.options.user_key+"&myid="+this.options.user_id+"&devid="+this.options.dev_id+"&v="+this.version+"&api=js"},this.UseWebSocket=function(e){return e===!0?this.use_WebSocket=e:e===!1&&(this.use_WebSocket=e),void 0===this.use_WebSocket&&(this.use_WebSocket=void 0!==window.WebSocket),this.use_WebSocket},this.start=function(e,t){return void 0!==e&&(this.options=e),this.LogLevel&&console.log([this.custom_id,e]),void 0===this.options&&(this.options={}),this.options.CookieKyeName||(this.options.CookieKyeName="CometUserKey"),this.options.CookieIdName||(this.options.CookieIdName="CometUserid"),this.options.user_key||(this.options.user_key=getCookie(this.options.CookieKyeName)),this.options.user_id||(this.options.user_id=getCookie(this.options.CometUserid)),this.UseWebSocket(void 0!==window.WebSocket),this.options.dev_id>0?(this.in_abort=!1,this.conect(t),!0):(console.error("Star.Comet: Не установлен dev_id"),!1)},this.stop=function(){this.is_master?(this.in_abort=!0,this.UseWebSocket()?this.socket.close():this.request.abort()):comet_server_signal().send_emit("comet_msg_slave_signal_stop")},this.restart=function(e,t){var s=this;this.is_master?(this.restart_time_id!==!1&&clearTimeout(this.restart_time_id),s.in_abort||(s.in_abort=!0,s.UseWebSocket()?s.socket.close():s.request.abort()),this.restart_time_id=setTimeout(function(){s.in_abort=!1,s.conect_to_server(e,t)},1e3)):comet_server_signal().send_emit("comet_msg_slave_signal_restart")},this.setAsMaster=function(){var e=this;this.is_master=!0,this.LogLevel&&console.log("setAsMaster"),comet_server_signal().send_emit("comet_msg_master_signal"),comet_server_signal().send_emit("comet_msg_new_master"),setInterval(function(){comet_server_signal().send_emit("comet_msg_master_signal")},this.start_timer/6),comet_server_signal().connect("comet_msg_slave_signal_restart",function(t,s){e.LogLevel&&console.log([t,s]),e.restart()}),comet_server_signal().connect("comet_msg_slave_signal_stop",function(t,s){e.LogLevel&&console.log([t,s]),e.stop()}),comet_server_signal().connect("comet_msg_slave_signal_start",function(t,s){e.LogLevel&&console.log([t,s]),e.start()}),comet_server_signal().connect("comet_msg_slave_add_subscription_and_restart",function(t,s){e.LogLevel&&console.log([t,s]),e.subscription(t)}),comet_server_signal().connect("comet_msg_slave_send_msg",function(t,s){e.LogLevel&&console.log([t,s]),e.send_msg(t)})},this.setAuthorized=function(e){this.LogLevel&&console.log("setAuthorized:",e),this.authorized_status=e,comet_server_signal().send_emit("__comet_authorized",this.status)},this.isAuthorized=function(){return this.authorized_status},this.hasCriticalError=!1,this.msg_cultivate=function(e){if(this.LogLevel&&console.log("msg",e),void 0===e.data)return-1;if(e.error>400&&(console.error("CometServerError:"+e.error,"\n",e.data,"\n","Критическая ошибка, подключение невозможно. Подробности в документации http://comet-server.ru/wiki/doku.php/comet:javascript_api:error"),this.hasCriticalError=!0),void 0!==e.authorized)return this.setAuthorized("true"===e.authorized),0;var t=0;if(/^A::/.test(e.data)){var s=e.data.split(";");t=s[0].replace("A::","")/1,e.data=s[1]}void 0===e.event_name?e.data=this.Base64.decode(e.data):e.data=this.stripslashes(e.data);try{this.LogLevel&&console.log(["msg",e.data,"web_id:"+t]);var o=JSON.parse(e.data);void 0!==o&&(e.data=o)}catch(r){}var i=e.data,n=e.event_name;void 0===e.event_name&&(i=e.data.data,n=e.data.event_name);var _={data:i,server_info:{user_id:t,pipe:e.pipe,event:n,history:e.history===!0,marker:e.marker}};return this.LogLevel&&console.log(["msg",e,_]),void 0!==e.pipe?(comet_server_signal().send_emit(e.pipe,_),void 0===n||"string"!=typeof n&&"number"!=typeof n||comet_server_signal().send_emit(e.pipe+"."+n,_)):void 0===n||"string"!=typeof n&&"number"!=typeof n?comet_server_signal().send_emit("msg",_):(comet_server_signal().send_emit("msg."+n,_),comet_server_signal().send_emit("msg",_)),comet_server_signal().send_emit("comet_server_msg",_),1},this.send_msg_from_queue=function(){var e=this;if(void 0===this.is_master)return!1;if(this.is_master===!1){if(this.send_msg_subscription!==!1&&(comet_server_signal().send_emit("comet_msg_slave_add_subscription_and_restart",this.send_msg_subscription),this.send_msg_subscription=!1),this.send_msg_queue.length>0){for(var t in this.send_msg_queue)comet_server_signal().send_emit("comet_msg_slave_send_msg",this.send_msg_queue[t]);this.send_msg_queue=[]}return!0}if(this.is_master){if(!this.UseWebSocket())return!1;if(this.socket&&1===this.socket.readyState){if(this.send_msg_subscription!==!1&&(this.LogLevel&&console.error("WebSocket-send-subscription:"+this.send_msg_subscription),this.socket.send(this.send_msg_subscription),this.send_msg_subscription=!1),this.send_msg_queue.length>0){for(var t in this.send_msg_queue)this.LogLevel&&console.log("WebSocket-send-msg:"+this.send_msg_queue[t]),setTimeout(function(t){e.socket.send(t)},10,this.send_msg_queue[t]);this.send_msg_queue=[]}return!0}}return!1},this.add_msg_to_queue=function(e){var t=!1;t=e.split("\n"),t=t[0],"subscription"==t?this.send_msg_subscription=e:this.send_msg_queue.push(e)},this.send_msg=function(e){if(void 0===this.is_master)return this.add_msg_to_queue(e),!1;if(this.is_master===!1)comet_server_signal().send_emit("comet_msg_slave_send_msg",e);else if(this.is_master)return this.UseWebSocket()?this.socket&&1===this.socket.readyState?(this.send_msg_from_queue(),this.LogLevel&&console.log("WebSocket-send-msg:"+e),this.socket.send(e),!0):(this.add_msg_to_queue(e),!1):(console.warn("WebSocket-send-msg: not use"),!1)},this.web_pipe_send=function(e,t,s){return void 0===s&&(s=t,t="undefined",/[.]/.test(e)&&(t=e.replace(/^[^.]*\.(.*)$/,"$1"),e=e.replace(/^(.*?)\.(.*)/,"$1"))),void 0===s?!1:(this.LogLevel&&console.log(["web_pipe_send",e,s]),this.send_msg("web_pipe\n"+e+"\n"+this.Base64.encode(JSON.stringify({data:s,event_name:t}))))},this.get_pipe_log=function(e,t){if(!this.UseWebSocket())return!1;var s=this.custom_id;return void 0!==t&&(s=this.getCustomString(),this.subscription(e),this.subscription_callBack(e,t,s)),this.send_msg("pipe_log\n"+e+"\n"+s+"\n"),!0},this.count_users_in_pipe=function(e,t){if(!this.UseWebSocket())return!1;var s=this.getCustomString();return this.subscription_callBack("_answer_pipe_count",t,s),this.send_msg("pipe_count\n"+e+"\n"+s+"\n"),!0},this.conect_to_server=function(){var e=this;if(this.in_conect_to_server)return void(this.LogLevel&&console.log("Соединение с сервером уже установлено."));if(this.LogLevel&&console.log("Соединение с сервером"),this.in_conect_to_server=!0,this.is_master||this.setAsMaster(),this.hasCriticalError)return!1;if(this.UseWebSocket())this.socket=new WebSocket(this.getUrl()),this.socket.onopen=function(){e.LogLevel&&console.log("WS Соединение установлено."),e.send_msg_subscription===!1&&e.send_curent_subscription(),e.send_msg_from_queue(),e.options.nostat||e.socket.send("statistics\n"+JSON.stringify({url:window.location.href,dev_id:e.options.dev_id}))},this.socket.onclose=function(t){t.wasClean?e.LogLevel&&console.log("WS Соединение закрыто чисто"):(e.LogLevel&&console.log("WS Обрыв соединения"),e.socket.close(),e.in_conect_to_server=!1,e.web_socket_error++,void 0!==e.web_socket_error_timeOut_id&&clearTimeout(e.web_socket_error_timeOut_id),e.web_socket_error_timeOut_id=setTimeout(function(){e.web_socket_error_timeOut_id=void 0,e.web_socket_error=0},e.web_socket_error_timeOut),e.web_socket_error>10&&e.web_socket_success!==!0?(e.UseWebSocket(!1),e.time_to_reconect_on_error=1e3,console.error("Произошло более 10 ошибок вебсокетов то перейдём на long poling")):e.web_socket_error>9&&(e.time_to_reconect_on_error=2e3),setTimeout(function(){e.conect_to_server()},e.time_to_reconect_on_error)),e.LogLevel&&console.log("WS Код: "+t.code+" причина: "+t.reason)},this.socket.onmessage=function(t){e.web_socket_success=!0,e.LogLevel>1&&console.log("WS Входящие сообщение:"+t.data);var s=t.data.replace(/^\s+|\s+$/,"").split("\n");for(var o in s){var r={};try{r=JSON.parse(s[o])}catch(i){e.LogLevel&&console.error(i);continue}e.msg_cultivate(r)}},this.socket.onerror=function(t){e.LogLevel&&console.log("Ошибка "+t.message)};else{try{this.request=new XMLHttpRequest}catch(t){try{this.request=new ActiveXObject("Msxml2.XMLHTTP")}catch(s){try{this.request=new ActiveXObject("Microsoft.XMLHTTP")}catch(o){this.request=!1}}}this.request.onreadystatechange=function(){if(200===e.request.status&&e.in_abort!==!0){var t=e.request.responseText;e.LogLevel&&console.log("Входящие сообщение:"+t);var s=t.replace(/^\s+|\s+$/,"").split("\n");for(var o in s){try{e.LogLevel&&console.log(s[o]);var r=JSON.parse(s[o])}catch(i){return e.in_conect_to_server=!1,e.LogLevel&&console.log("Ошибка в xhr, переподключение через "+e.time_to_reconect_on_error+" секунды."),setTimeout(function(){e.conect_to_server()},e.time_to_reconect_on_error),!1}e.msg_cultivate(r)}e.in_conect_to_server=!1,e.conect_to_server()}else e.in_conect_to_server=!1,e.in_abort!==!0&&(e.xhr_error+=1,e.xhr_error>30?e.time_to_reconect_on_error=9e4:e.xhr_error>10?e.time_to_reconect_on_error=3e4:e.xhr_error>3&&(e.time_to_reconect_on_error=1e4),e.LogLevel,console.log("Ошибка в xhr, переподключение через "+e.time_to_reconect_on_error+" секунды."),setTimeout(function(){e.conect_to_server()},e.time_to_reconect_on_error),setTimeout(function(){e.xhr_error=0},e.xhr_error_timeOut_id))},this.request.open("POST",this.getUrl(),!0),this.request.send(this.subscription_array.join("\n"))}},this.conect=function(e){var t=this;if(this.is_master)return this.conect_to_server();if(this.in_try_conect)return this.LogLevel&&console.log("Соединение с сервером уже установлено на другой вкладке"),comet_server_signal().send_emit("comet_msg_slave_signal_start"),!1;this.in_try_conect=!0,void 0===e&&(e=function(){}),this.LogLevel&&console.log("Попыдка соединения с сервером");var s=!1,o=!1;comet_server_signal().connect("slot_comet_msg_set_as_slave","comet_msg_set_as_slave",function(){console.log("comet_msg_set_as_slave: set is slave"),t.send_msg_from_queue()}),comet_server_signal().connect("comet_msg_conect","comet_msg_master_signal",function(){s!==!1&&(clearTimeout(s),s=!1,t.LogLevel&&console.log("Соединение с сервером отменено"),comet_server_signal().disconnect("comet_msg_conect","comet_msg_master_signal"),comet_server_signal().connect("comet_msg_conect_to_master_signal","comet_msg_master_signal",function(){o!==!1&&clearTimeout(o),o=setTimeout(function(){comet_server_signal().disconnect("comet_msg_conect_to_master_signal","comet_msg_master_signal"),t.in_try_conect=!1,t.conect_to_server(),e()},t.start_timer)})),t.LogLevel&&console.log("set is slave"),t.is_master=!1,comet_server_signal().emit("comet_msg_set_as_slave","slave")}),s=setTimeout(function(){comet_server_signal().disconnect("comet_msg_conect","comet_msg_master_signal"),t.in_try_conect=!1,t.conect_to_server(),e()},this.start_timer)}};var __CometServer=void 0;